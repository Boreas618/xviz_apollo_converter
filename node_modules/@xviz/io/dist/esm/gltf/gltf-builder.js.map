{"version":3,"file":"gltf-builder.js","names":["getBinaryImageMetadata","assert","KHR_DRACO_MESH_COMPRESSION","UBER_POINT_CLOUD_EXTENSION","GLBBuilder","packBinaryJson","GLTFBuilder","options","DracoWriter","DracoLoader","key","data","packOptions","jsonData","nopack","json","packedJson","extras","extensionName","extensions","registerUsedExtension","addExtension","registerRequiredExtension","extensionsUsed","find","ext","push","extensionsRequired","attributes","indices","mode","accessors","_addAttributes","glTFMesh","primitives","meshes","length","accessorIndices","Error","compressedData","encodeSync","decodedData","parseSync","fauxAccessors","_addFauxAttributes","bufferViewIndex","addBufferView","bufferView","pointcloud","imageData","sizeAndType","mimeType","width","height","images"],"sources":["../../../src/gltf/gltf-builder.js"],"sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\nimport {getBinaryImageMetadata} from '@loaders.gl/images';\nimport {assert} from './assert';\nimport {KHR_DRACO_MESH_COMPRESSION, UBER_POINT_CLOUD_EXTENSION} from './gltf-constants';\nimport GLBBuilder from './glb-builder';\nimport {packBinaryJson} from '../writers/xviz-pack-binary';\n\nexport class GLTFBuilder extends GLBBuilder {\n  constructor(options = {}) {\n    super(options);\n\n    // Soft dependency on DRACO, app needs to import and supply these\n    this.DracoWriter = options.DracoWriter;\n    this.DracoLoader = options.DracoLoader;\n  }\n\n  // NOTE: encode() inherited from GLBBuilder\n\n  // TODO - support encoding to non-GLB versions of glTF format\n  // Encode as a textual JSON file with binary data in base64 data URLs.\n  // encodeAsDataURLs(options)\n  // Encode as a JSON with all images (and buffers?) in separate binary files\n  // encodeAsSeparateFiles(options)\n\n  // Add an extra application-defined key to the top-level data structure\n  // By default packs JSON by extracting binary data and replacing it with JSON pointers\n  addApplicationData(key, data, packOptions = {}) {\n    const jsonData = packOptions.nopack ? data : packBinaryJson(data, this, null, packOptions);\n    this.json[key] = jsonData;\n    return this;\n  }\n\n  // `extras` - Standard GLTF field for storing application specific data\n  // By default packs JSON by extracting binary data and replacing it with JSON pointers\n  addExtraData(key, data, packOptions = {}) {\n    const packedJson = packOptions.nopack ? data : packBinaryJson(data, this, null, packOptions);\n    this.json.extras = this.json.extras || {};\n    this.json.extras[key] = packedJson;\n    return this;\n  }\n\n  // Add to standard GLTF top level extension object, mark as used\n  // By default packs JSON by extracting binary data and replacing it with JSON pointers\n  addExtension(extensionName, data, packOptions = {}) {\n    assert(data);\n    const packedJson = packOptions.nopack ? data : packBinaryJson(data, this, null, packOptions);\n    this.json.extensions = this.json.extensions || {};\n    this.json.extensions[extensionName] = packedJson;\n    this.registerUsedExtension(extensionName);\n    return this;\n  }\n\n  // Standard GLTF top level extension object, mark as used and required\n  // By default packs JSON by extracting binary data and replacing it with JSON pointers\n  addRequiredExtension(extensionName, data, packOptions = {}) {\n    assert(data);\n    const packedJson = packOptions.nopack ? data : packBinaryJson(data, this, null, packOptions);\n    this.addExtension(extensionName, packedJson);\n    this.registerRequiredExtension(extensionName);\n    return this;\n  }\n\n  // Add extensionName to list of used extensions\n  registerUsedExtension(extensionName) {\n    this.json.extensionsUsed = this.json.extensionsUsed || [];\n    if (!this.json.extensionsUsed.find(ext => ext === extensionName)) {\n      this.json.extensionsUsed.push(extensionName);\n    }\n  }\n\n  // Add extensionName to list of required extensions\n  registerRequiredExtension(extensionName) {\n    this.registerUsedExtension(extensionName);\n    this.json.extensionsRequired = this.json.extensionsRequired || [];\n    if (!this.json.extensionsRequired.find(ext => ext === extensionName)) {\n      this.json.extensionsRequired.push(extensionName);\n    }\n  }\n\n  // mode:\n  // POINTS:  0x0000,\n  // LINES: 0x0001,\n  // LINE_LOOP: 0x0002,\n  // LINE_STRIP:  0x0003,\n  // TRIANGLES: 0x0004,\n  // TRIANGLE_STRIP:  0x0005,\n  // TRIANGLE_FAN:  0x0006,\n\n  addMesh(attributes, indices, mode = 4) {\n    const accessors = this._addAttributes(attributes);\n\n    const glTFMesh = {\n      primitives: [\n        {\n          attributes: accessors,\n          indices,\n          mode\n        }\n      ]\n    };\n\n    this.json.meshes = this.json.meshes || [];\n    this.json.meshes.push(glTFMesh);\n    return this.json.meshes.length - 1;\n  }\n\n  addPointCloud(attributes) {\n    const accessorIndices = this._addAttributes(attributes);\n\n    const glTFMesh = {\n      primitives: [\n        {\n          attributes: accessorIndices,\n          mode: 0 // GL.POINTS\n        }\n      ]\n    };\n\n    this.json.meshes = this.json.meshes || [];\n    this.json.meshes.push(glTFMesh);\n    return this.json.meshes.length - 1;\n  }\n\n  // eslint-disable-next-line max-len\n  // https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_draco_mesh_compression\n  // Only TRIANGLES: 0x0004 and TRIANGLE_STRIP: 0x0005 are supported\n  addCompressedMesh(attributes, indices, mode = 4) {\n    if (!this.DracoWriter || !this.DracoLoader) {\n      throw new Error('DracoWriter/DracoLoader not available');\n    }\n\n    // Since we do not add fallback data\n    this.registerRequiredExtension(KHR_DRACO_MESH_COMPRESSION);\n\n    const compressedData = this.DracoWriter.encodeSync({attributes});\n\n    // Draco compression may change the order and number of vertices in a mesh.\n    // To satisfy the requirement that accessors properties be correct for both\n    // compressed and uncompressed data, generators should create uncompressed\n    // attributes and indices using data that has been decompressed from the Draco buffer,\n    // rather than the original source data.\n    const decodedData = this.DracoLoader.parseSync({attributes});\n    const fauxAccessors = this._addFauxAttributes(decodedData.attributes);\n\n    const bufferViewIndex = this.addBufferView(compressedData);\n\n    const glTFMesh = {\n      primitives: [\n        {\n          attributes: fauxAccessors, // TODO - verify with spec\n          mode, // GL.POINTS\n          extensions: {\n            [KHR_DRACO_MESH_COMPRESSION]: {\n              bufferView: bufferViewIndex,\n              attributes: fauxAccessors // TODO - verify with spec\n            }\n          }\n        }\n      ]\n    };\n\n    this.json.meshes = this.json.meshes || [];\n    this.json.meshes.push(glTFMesh);\n    return this.json.meshes.length - 1;\n  }\n\n  addCompressedPointCloud(attributes) {\n    if (!this.DracoWriter || !this.DracoLoader) {\n      throw new Error('DracoWriter/DracoLoader not available');\n    }\n\n    attributes.mode = 0;\n    const compressedData = this.DracoWriter.encodeSync(attributes, {pointcloud: true});\n\n    const bufferViewIndex = this.addBufferView(compressedData);\n\n    const glTFMesh = {\n      primitives: [\n        {\n          attributes: {}, // This will be populated after decompression\n          mode: 0, // GL.POINTS\n          extensions: {\n            [UBER_POINT_CLOUD_EXTENSION]: {\n              bufferView: bufferViewIndex\n            }\n          }\n        }\n      ]\n    };\n\n    this.registerRequiredExtension(UBER_POINT_CLOUD_EXTENSION);\n\n    this.json.meshes = this.json.meshes || [];\n    this.json.meshes.push(glTFMesh);\n    return this.json.meshes.length - 1;\n  }\n\n  // Adds a binary image. Builds glTF \"JSON metadata\" and saves buffer reference\n  // Buffer will be copied into BIN chunk during \"pack\"\n  // Currently encodes as glTF image\n  addImage(imageData) {\n    const bufferViewIndex = this.addBufferView(imageData);\n\n    // Get the properties of the image to add as metadata.\n    const sizeAndType = getBinaryImageMetadata(imageData) || {};\n    if (sizeAndType) {\n      // width and height are non-spec fields\n      const {mimeType, width, height} = sizeAndType;\n      this.json.images.push({\n        bufferView: bufferViewIndex,\n        mimeType,\n        width,\n        height\n      });\n    } else {\n      // TODO: Spec violation, if we are using a bufferView, mimeType must be defined:\n      //   https://github.com/KhronosGroup/glTF/tree/master/specification/2.0#images\n      //   \"a reference to a bufferView; in that case mimeType must be defined.\"\n      this.json.images.push({\n        bufferView: bufferViewIndex\n      });\n    }\n\n    return this.json.images.length - 1;\n  }\n}\n"],"mappings":"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"}