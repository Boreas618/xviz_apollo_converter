{"version":3,"file":"flatten.js","names":["isFlattened","array","Number","isFinite","flattenToTypedArray","nestedArray","dimensions","ArrayType","Float32Array","length","checkVertices","from","count","countVertices","typedArray","flattenVerticesInPlace","nestedCount","localCount","index","value","Array","isArray","ArrayBuffer","isView","predicate","result","flattenVerticesInPlaceRecursive","insert","vertexLength"],"sources":["../../../src/writers/flatten.js"],"sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nfunction isFlattened(array) {\n  return Number.isFinite(array[0]);\n}\n\nexport function flattenToTypedArray(nestedArray, dimensions = 3, ArrayType = Float32Array) {\n  if (nestedArray.length === 0) {\n    return new Float32Array(0);\n  }\n\n  if (!checkVertices(nestedArray)) {\n    return null;\n  }\n\n  // Handle case where the array is already flattened.\n  if (isFlattened(nestedArray)) {\n    return ArrayType.from(nestedArray);\n  }\n\n  const count = countVertices(nestedArray, dimensions);\n\n  const typedArray = new ArrayType(count);\n  flattenVerticesInPlace(nestedArray, typedArray, dimensions);\n  return typedArray;\n}\n\nfunction countVertices(nestedArray, dimensions = 3) {\n  let nestedCount = 0;\n  let localCount = 0;\n  let index = -1;\n  while (++index < nestedArray.length) {\n    const value = nestedArray[index];\n    if (Array.isArray(value) || ArrayBuffer.isView(value)) {\n      nestedCount += countVertices(value);\n    } else {\n      localCount++;\n    }\n  }\n  return nestedCount + (nestedCount === 0 && localCount < dimensions ? dimensions : localCount);\n}\n\nfunction checkVertices(nestedArray, predicate = Number.isFinite) {\n  let index = -1;\n  while (++index < nestedArray.length) {\n    const value = nestedArray[index];\n    if (Array.isArray(value) || ArrayBuffer.isView(value)) {\n      if (!checkVertices(value, predicate)) {\n        return false;\n      }\n    } else if (!predicate(value)) {\n      return false;\n    }\n  }\n  return true;\n}\n\nfunction flattenVerticesInPlace(nestedArray, result, dimensions = 3) {\n  flattenVerticesInPlaceRecursive(nestedArray, result, dimensions, 0);\n  return result;\n}\n\n// Flattens nested array of vertices, padding third coordinate as needed\nfunction flattenVerticesInPlaceRecursive(nestedArray, result, dimensions, insert) {\n  let index = -1;\n  let vertexLength = 0;\n  while (++index < nestedArray.length) {\n    const value = nestedArray[index];\n    if (Array.isArray(value) || ArrayBuffer.isView(value)) {\n      insert = flattenVerticesInPlaceRecursive(value, result, dimensions, insert);\n    } else {\n      // eslint-disable-next-line\n      if (vertexLength < dimensions) {\n        result[insert++] = value;\n        vertexLength++;\n      }\n    }\n  }\n  // Add a third coordinate if needed\n  if (vertexLength > 0 && vertexLength < dimensions) {\n    result[insert++] = 0;\n  }\n  return insert;\n}\n"],"mappings":"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"}