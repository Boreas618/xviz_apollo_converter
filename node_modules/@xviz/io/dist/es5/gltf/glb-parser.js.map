{"version":3,"file":"glb-parser.js","names":["GLBParser","arrayBuffer","options","parseSync","glbArrayBuffer","binaryByteOffset","packedJson","json","byteOffset","parseGLBSync","binChunkByteOffset","unpackedBuffers","unpackGLTFBuffers","unpackBinaryJson","key","glTFBufferView","Uint8Array","byteLength","glTFAccessor","ArrayType","ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY","componentType","components","ATTRIBUTE_TYPE_TO_COMPONENTS","type","bytesPerComponent","ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE","length","count","bufferViews","bufferView","assert","glTFImage","typedArray","getBufferView","mimeType","arrayBufferView","blob","Blob","urlCreator","self","URL","webkitURL","imageUrl","createObjectURL","img","Image","src","Promise","resolve","onload","isGLB"],"sources":["../../../src/gltf/glb-parser.js"],"sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n/* eslint-disable camelcase, max-statements, no-restricted-globals, no-redeclare */\nimport {assert} from './assert';\nimport parseGLBSync, {isGLB} from './parse-glb';\nimport {\n  ATTRIBUTE_TYPE_TO_COMPONENTS,\n  ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE,\n  ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY\n} from './gltf-utils/gltf-utils';\nimport unpackBinaryJson from './packed-json/unpack-binary-json';\nimport unpackGLTFBuffers from './packed-json/unpack-gltf-buffers';\n\nexport default class GLBParser {\n  static isGLB(arrayBuffer, options = {}) {\n    const byteOffset = 0;\n    return isGLB(arrayBuffer, byteOffset);\n  }\n\n  // Return the gltf JSON and the original arrayBuffer\n  parse(arrayBuffer, options = {}) {\n    return this.parseSync(arrayBuffer, options);\n  }\n\n  parseSync(arrayBuffer, options = {}) {\n    this.glbArrayBuffer = arrayBuffer;\n\n    this.binaryByteOffset = null;\n    this.packedJson = null;\n    this.json = null;\n\n    // Only parse once\n    if (this.json === null && this.binaryByteOffset === null) {\n      const byteOffset = 0;\n\n      // Populates the supplied object (`this`) with parsed data members.\n      parseGLBSync(this, this.glbArrayBuffer, byteOffset, options);\n\n      // Backwards compat\n      this.binaryByteOffset = this.binChunkByteOffset;\n\n      // Unpack binary JSON\n      this.packedJson = this.json;\n\n      const unpackedBuffers = unpackGLTFBuffers(\n        this.glbArrayBuffer,\n        this.json,\n        this.binaryByteOffset\n      );\n      this.json = unpackBinaryJson(this.json, unpackedBuffers);\n\n      this.unpackedBuffers = unpackedBuffers;\n    }\n\n    return this;\n  }\n\n  // Returns application JSON data stored in `key`\n  getApplicationData(key) {\n    if (this.json) {\n      return this.json[key];\n    }\n\n    return null;\n  }\n\n  // Returns JSON envelope\n  getJSON() {\n    return this.json;\n  }\n\n  // Return binary chunk\n  getArrayBuffer() {\n    return this.glbArrayBuffer;\n  }\n\n  // Return index into binary chunk\n  getBinaryByteOffset() {\n    return this.binaryByteOffset;\n  }\n\n  // Unpacks a bufferview into a new Uint8Array that is a view into the binary chunk\n  getBufferView(glTFBufferView) {\n    const byteOffset = (glTFBufferView.byteOffset || 0) + this.binaryByteOffset;\n    return new Uint8Array(this.glbArrayBuffer, byteOffset, glTFBufferView.byteLength);\n  }\n\n  // Unpacks a glTF accessor into a new typed array that is a view into the binary chunk\n  getBuffer(glTFAccessor) {\n    // Decode the glTF accessor format\n    const ArrayType = ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY[glTFAccessor.componentType];\n    const components = ATTRIBUTE_TYPE_TO_COMPONENTS[glTFAccessor.type];\n    const bytesPerComponent = ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE[glTFAccessor.componentType];\n    const length = glTFAccessor.count * components;\n    const byteLength = glTFAccessor.count * components * bytesPerComponent;\n\n    // Get the boundaries of the binary sub-chunk for this bufferView\n    const glTFBufferView = this.json.bufferViews[glTFAccessor.bufferView];\n    assert(byteLength >= 0 && glTFAccessor.byteOffset + byteLength <= glTFBufferView.byteLength);\n\n    const byteOffset = glTFBufferView.byteOffset + this.binaryByteOffset + glTFAccessor.byteOffset;\n    return new ArrayType(this.glbArrayBuffer, byteOffset, length);\n  }\n\n  // Unpacks an image into an HTML image\n  getImageData(glTFImage) {\n    return {\n      typedArray: this.getBufferView(glTFImage.bufferView),\n      mimeType: glTFImage.mimeType || 'image/jpeg'\n    };\n  }\n\n  getImage(glTFImage) {\n    /* global self, Blob, Image */\n    const arrayBufferView = this.getBufferView(glTFImage.bufferView);\n    const mimeType = glTFImage.mimeType || 'image/jpeg';\n    const blob = new Blob([arrayBufferView], {type: mimeType});\n    const urlCreator = self.URL || self.webkitURL;\n    const imageUrl = urlCreator.createObjectURL(blob);\n    const img = new Image();\n    img.src = imageUrl;\n    return img;\n  }\n\n  getImageAsync(glTFImage) {\n    /* global self, Blob, Image */\n    return new Promise(resolve => {\n      const arrayBufferView = this.getBufferView(glTFImage.bufferView);\n      const mimeType = glTFImage.mimeType || 'image/jpeg';\n      const blob = new Blob([arrayBufferView], {type: mimeType});\n      const urlCreator = self.URL || self.webkitURL;\n      const imageUrl = urlCreator.createObjectURL(blob);\n      const img = new Image();\n      img.onload = () => resolve(img);\n      img.src = imageUrl;\n    });\n  }\n}\n"],"mappings":"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"}