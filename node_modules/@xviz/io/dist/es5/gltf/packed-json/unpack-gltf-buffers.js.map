{"version":3,"file":"unpack-gltf-buffers.js","names":["unpackGLBBuffers","arrayBuffer","json","binaryByteOffset","getArrayBufferAtOffset","bufferViews","i","length","bufferView","assert","byteLength","accessors","unpackAccessors","images","unpackImages","accessorBuffers","accessor","getAccessorArrayTypeAndLength","ArrayType","array","byteOffset","push","imageBuffers","image","Uint8Array","imate","binaryBuffer","ArrayBuffer","sourceArray","binaryArray"],"sources":["../../../../src/gltf/packed-json/unpack-gltf-buffers.js"],"sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\nimport {assert} from '../assert';\nimport {getAccessorArrayTypeAndLength} from '../gltf-utils/gltf-utils';\n\nexport default function unpackGLBBuffers(arrayBuffer, json, binaryByteOffset) {\n  // TODO - really inefficient, should just use the offset into the original array buffer\n  if (binaryByteOffset) {\n    arrayBuffer = getArrayBufferAtOffset(arrayBuffer, binaryByteOffset);\n  }\n\n  const bufferViews = json.bufferViews || [];\n\n  for (let i = 0; i < bufferViews.length; ++i) {\n    const bufferView = bufferViews[i];\n    assert(bufferView.byteLength >= 0);\n  }\n\n  return {\n    // TODO: delete unpackAccessors and use buffer views only?\n    accessors: unpackAccessors(arrayBuffer, bufferViews, json),\n    images: unpackImages(arrayBuffer, bufferViews, json)\n  };\n}\n\nfunction unpackAccessors(arrayBuffer, bufferViews, json) {\n  // unpack accessors\n  const accessors = json.accessors || [];\n\n  const accessorBuffers = [];\n\n  for (let i = 0; i < accessors.length; ++i) {\n    const accessor = accessors[i];\n    assert(accessor);\n\n    const bufferView = bufferViews[accessor.bufferView];\n    // Draco encoded meshes don't have bufferView in accessor\n    if (bufferView) {\n      // Create a new typed array as a view into the combined buffer\n      const {ArrayType, length} = getAccessorArrayTypeAndLength(accessor, bufferView);\n      const array = new ArrayType(arrayBuffer, bufferView.byteOffset, length);\n      // Store the metadata on the array (e.g. needed to determine number of components per element)\n      array.accessor = accessor;\n      accessorBuffers.push(array);\n    }\n  }\n\n  return accessorBuffers;\n}\n\nfunction unpackImages(arrayBuffer, bufferViews, json) {\n  // unpack images\n  const images = json.images || [];\n\n  const imageBuffers = [];\n\n  for (let i = 0; i < images.length; ++i) {\n    const image = images[i];\n    assert(image);\n\n    const bufferView = bufferViews[image.bufferView];\n    assert(bufferView);\n\n    // Create a new typed array as a view into the combined buffer\n    const array = new Uint8Array(arrayBuffer, bufferView.byteOffset, bufferView.byteLength);\n    // Store the metadata on the array (e.g. needed to determine number of components per element)\n    array.imate = image;\n    imageBuffers.push(array);\n  }\n\n  return imageBuffers;\n}\n\n// Helper methods\n\n// json.accessors = json.accessors || [];\n// json.bufferViews = json.bufferViews || [];\n\n// Creates a new ArrayBuffer starting at the offset, containing all remaining bytes\n// TODO - should not be needed, see above\nfunction getArrayBufferAtOffset(arrayBuffer, byteOffset) {\n  const length = arrayBuffer.byteLength - byteOffset;\n  const binaryBuffer = new ArrayBuffer(length);\n  const sourceArray = new Uint8Array(arrayBuffer);\n  const binaryArray = new Uint8Array(binaryBuffer);\n  for (let i = 0; i < length; i++) {\n    binaryArray[i] = sourceArray[byteOffset + i];\n  }\n  return binaryBuffer;\n}\n"],"mappings":"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"}