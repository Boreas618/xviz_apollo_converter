{"version":3,"file":"xviz-data.js","names":["XVIZData","data","opts","_data","_opts","_dataFormat","undefined","_xvizType","_message","_determineFormat","Error","type","rawType","messageType","getXVIZMessageType","parts","split","namespace","msg","XVIZ_FORMAT","BINARY_GLB","Buffer","buffer","slice","byteOffset","byteLength","parseBinaryXVIZ","BINARY_PBE","JSON_BUFFER","jsonString","toString","ArrayBuffer","isView","Uint8Array","TextDecoder","decode","JSON","parse","JSON_STRING","OBJECT","xvizMsg","XVIZMessage","messageFormat","getDataContainer","isPBEXVIZ","isGLBXVIZ","isJSONString"],"sources":["../../../src/common/xviz-data.js"],"sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n/* global Buffer */\n/* eslint-disable complexity */\nimport {\n  getDataContainer,\n  parseBinaryXVIZ,\n  isGLBXVIZ,\n  isJSONString,\n  isPBEXVIZ,\n  getXVIZMessageType\n} from './loaders';\nimport {XVIZMessage} from './xviz-message';\nimport {TextDecoder} from './text-encoding';\nimport {XVIZ_FORMAT} from './constants';\n\n// Represents raw xviz data and\n// can create an XVIZMessage\n//\n// Assume isXVIZMessage has been called\n//\n// Raw data formats supported:\n// - JSON string\n// - arraybuffer which is a JSON string\n// - JSON object\n// - arraybuffer which is a GLB\n// opts.messageType is the message type contained in data.\n// - If supplied it assume data does not have an Envelope.\n// - Can be one of ('xviz/state_update', 'xviz/metadata', etc.)\nexport class XVIZData {\n  constructor(data, opts = {}) {\n    this._data = data;\n    this._opts = opts;\n\n    // _dataFormat is an XVIZ_FORMAT for 'data'\n    this._dataFormat = undefined;\n\n    // _xvizType is the XVIZ Envelope 'type'\n    this._xvizType = undefined;\n\n    // _message is an XVIZMessage and has been fully parsed\n    this._message = undefined;\n\n    this._determineFormat();\n\n    if (!this._dataFormat) {\n      throw new Error('Unknown XVIZ data format');\n    }\n  }\n\n  get buffer() {\n    return this._data;\n  }\n\n  get format() {\n    return this._dataFormat;\n  }\n\n  // In some cases this can be as expensive as a parse, so we do not\n  // load this unless asked for explicitly.\n  get type() {\n    if (this._message) {\n      return this._message.type;\n    } else if (!this._xvizType) {\n      const rawType = this._opts.messageType || getXVIZMessageType(this._data);\n      if (rawType) {\n        const parts = rawType.split('/');\n        this._xvizType = {\n          namespace: parts[0],\n          type: parts[1]\n        };\n      }\n    }\n\n    return this._xvizType.type;\n  }\n\n  hasMessage() {\n    return this._message !== undefined;\n  }\n\n  // converts data to JS object\n  message() {\n    let msg = null;\n    if (this._message) {\n      return this._message;\n    }\n\n    let data = this._data;\n    switch (this._dataFormat) {\n      case XVIZ_FORMAT.BINARY_GLB:\n        if (data instanceof Buffer) {\n          data = data.buffer.slice(data.byteOffset, data.byteOffset + data.byteLength);\n        }\n        msg = parseBinaryXVIZ(data);\n        break;\n      case XVIZ_FORMAT.BINARY_PBE:\n        if (data instanceof Buffer) {\n          data = data.buffer.slice(data.byteOffset, data.byteOffset + data.byteLength);\n        }\n        msg = parseBinaryXVIZ(data, this._opts);\n        break;\n      case XVIZ_FORMAT.JSON_BUFFER:\n        let jsonString = null;\n        if (data instanceof Buffer) {\n          // Default to utf8 encoding\n          jsonString = data.toString();\n        } else if (data instanceof ArrayBuffer || ArrayBuffer.isView(data)) {\n          data = new Uint8Array(data);\n\n          // This is slow\n          jsonString = new TextDecoder('utf8').decode(data);\n        }\n\n        msg = JSON.parse(jsonString);\n        break;\n      case XVIZ_FORMAT.JSON_STRING:\n        msg = JSON.parse(data);\n        break;\n      case XVIZ_FORMAT.OBJECT:\n        msg = data;\n        break;\n      default:\n        throw new Error(`Unsupported format ${this._dataFormat}`);\n    }\n\n    const xvizMsg = new XVIZMessage(msg);\n    if (xvizMsg.data) {\n      this._message = xvizMsg;\n      return this._message;\n    }\n\n    return null;\n  }\n\n  _determineFormat() {\n    const {messageFormat} = this._opts;\n    if (messageFormat) {\n      this._dataFormat = messageFormat;\n      return;\n    }\n\n    let data = this._data;\n    switch (getDataContainer(data)) {\n      case 'binary':\n        if (data instanceof Buffer) {\n          data = data.buffer.slice(data.byteOffset, data.byteOffset + data.byteLength);\n        }\n\n        if (isPBEXVIZ(data)) {\n          this._dataFormat = XVIZ_FORMAT.BINARY_PBE;\n        } else if (isGLBXVIZ(data)) {\n          this._dataFormat = XVIZ_FORMAT.BINARY_GLB;\n        } else {\n          if (data instanceof ArrayBuffer) {\n            data = new Uint8Array(data);\n          }\n\n          if (isJSONString(data)) {\n            this._dataFormat = XVIZ_FORMAT.JSON_BUFFER;\n          }\n        }\n        break;\n      case 'string':\n        if (isJSONString(data)) {\n          this._dataFormat = XVIZ_FORMAT.JSON_STRING;\n        }\n        break;\n      case 'object':\n        this._dataFormat = XVIZ_FORMAT.OBJECT;\n        break;\n\n      default:\n    }\n  }\n}\n"],"mappings":";;;;;;;;;;;;;AAeA;;AAQA;;AACA;;AACA;;IAeaA,Q;EACX,kBAAYC,IAAZ,EAA6B;IAAA,IAAXC,IAAW,uEAAJ,EAAI;IAAA;IAC3B,KAAKC,KAAL,GAAaF,IAAb;IACA,KAAKG,KAAL,GAAaF,IAAb;IAGA,KAAKG,WAAL,GAAmBC,SAAnB;IAGA,KAAKC,SAAL,GAAiBD,SAAjB;IAGA,KAAKE,QAAL,GAAgBF,SAAhB;;IAEA,KAAKG,gBAAL;;IAEA,IAAI,CAAC,KAAKJ,WAAV,EAAuB;MACrB,MAAM,IAAIK,KAAJ,CAAU,0BAAV,CAAN;IACD;EACF;;;;SAED,eAAa;MACX,OAAO,KAAKP,KAAZ;IACD;;;SAED,eAAa;MACX,OAAO,KAAKE,WAAZ;IACD;;;SAID,eAAW;MACT,IAAI,KAAKG,QAAT,EAAmB;QACjB,OAAO,KAAKA,QAAL,CAAcG,IAArB;MACD,CAFD,MAEO,IAAI,CAAC,KAAKJ,SAAV,EAAqB;QAC1B,IAAMK,OAAO,GAAG,KAAKR,KAAL,CAAWS,WAAX,IAA0B,IAAAC,2BAAA,EAAmB,KAAKX,KAAxB,CAA1C;;QACA,IAAIS,OAAJ,EAAa;UACX,IAAMG,KAAK,GAAGH,OAAO,CAACI,KAAR,CAAc,GAAd,CAAd;UACA,KAAKT,SAAL,GAAiB;YACfU,SAAS,EAAEF,KAAK,CAAC,CAAD,CADD;YAEfJ,IAAI,EAAEI,KAAK,CAAC,CAAD;UAFI,CAAjB;QAID;MACF;;MAED,OAAO,KAAKR,SAAL,CAAeI,IAAtB;IACD;;;WAED,sBAAa;MACX,OAAO,KAAKH,QAAL,KAAkBF,SAAzB;IACD;;;WAGD,mBAAU;MACR,IAAIY,GAAG,GAAG,IAAV;;MACA,IAAI,KAAKV,QAAT,EAAmB;QACjB,OAAO,KAAKA,QAAZ;MACD;;MAED,IAAIP,IAAI,GAAG,KAAKE,KAAhB;;MACA,QAAQ,KAAKE,WAAb;QACE,KAAKc,sBAAA,CAAYC,UAAjB;UACE,IAAInB,IAAI,YAAYoB,MAApB,EAA4B;YAC1BpB,IAAI,GAAGA,IAAI,CAACqB,MAAL,CAAYC,KAAZ,CAAkBtB,IAAI,CAACuB,UAAvB,EAAmCvB,IAAI,CAACuB,UAAL,GAAkBvB,IAAI,CAACwB,UAA1D,CAAP;UACD;;UACDP,GAAG,GAAG,IAAAQ,wBAAA,EAAgBzB,IAAhB,CAAN;UACA;;QACF,KAAKkB,sBAAA,CAAYQ,UAAjB;UACE,IAAI1B,IAAI,YAAYoB,MAApB,EAA4B;YAC1BpB,IAAI,GAAGA,IAAI,CAACqB,MAAL,CAAYC,KAAZ,CAAkBtB,IAAI,CAACuB,UAAvB,EAAmCvB,IAAI,CAACuB,UAAL,GAAkBvB,IAAI,CAACwB,UAA1D,CAAP;UACD;;UACDP,GAAG,GAAG,IAAAQ,wBAAA,EAAgBzB,IAAhB,EAAsB,KAAKG,KAA3B,CAAN;UACA;;QACF,KAAKe,sBAAA,CAAYS,WAAjB;UACE,IAAIC,UAAU,GAAG,IAAjB;;UACA,IAAI5B,IAAI,YAAYoB,MAApB,EAA4B;YAE1BQ,UAAU,GAAG5B,IAAI,CAAC6B,QAAL,EAAb;UACD,CAHD,MAGO,IAAI7B,IAAI,YAAY8B,WAAhB,IAA+BA,WAAW,CAACC,MAAZ,CAAmB/B,IAAnB,CAAnC,EAA6D;YAClEA,IAAI,GAAG,IAAIgC,UAAJ,CAAehC,IAAf,CAAP;YAGA4B,UAAU,GAAG,IAAIK,yBAAJ,CAAgB,MAAhB,EAAwBC,MAAxB,CAA+BlC,IAA/B,CAAb;UACD;;UAEDiB,GAAG,GAAGkB,IAAI,CAACC,KAAL,CAAWR,UAAX,CAAN;UACA;;QACF,KAAKV,sBAAA,CAAYmB,WAAjB;UACEpB,GAAG,GAAGkB,IAAI,CAACC,KAAL,CAAWpC,IAAX,CAAN;UACA;;QACF,KAAKkB,sBAAA,CAAYoB,MAAjB;UACErB,GAAG,GAAGjB,IAAN;UACA;;QACF;UACE,MAAM,IAAIS,KAAJ,8BAAgC,KAAKL,WAArC,EAAN;MAlCJ;;MAqCA,IAAMmC,OAAO,GAAG,IAAIC,wBAAJ,CAAgBvB,GAAhB,CAAhB;;MACA,IAAIsB,OAAO,CAACvC,IAAZ,EAAkB;QAChB,KAAKO,QAAL,GAAgBgC,OAAhB;QACA,OAAO,KAAKhC,QAAZ;MACD;;MAED,OAAO,IAAP;IACD;;;WAED,4BAAmB;MACjB,IAAOkC,aAAP,GAAwB,KAAKtC,KAA7B,CAAOsC,aAAP;;MACA,IAAIA,aAAJ,EAAmB;QACjB,KAAKrC,WAAL,GAAmBqC,aAAnB;QACA;MACD;;MAED,IAAIzC,IAAI,GAAG,KAAKE,KAAhB;;MACA,QAAQ,IAAAwC,yBAAA,EAAiB1C,IAAjB,CAAR;QACE,KAAK,QAAL;UACE,IAAIA,IAAI,YAAYoB,MAApB,EAA4B;YAC1BpB,IAAI,GAAGA,IAAI,CAACqB,MAAL,CAAYC,KAAZ,CAAkBtB,IAAI,CAACuB,UAAvB,EAAmCvB,IAAI,CAACuB,UAAL,GAAkBvB,IAAI,CAACwB,UAA1D,CAAP;UACD;;UAED,IAAI,IAAAmB,kBAAA,EAAU3C,IAAV,CAAJ,EAAqB;YACnB,KAAKI,WAAL,GAAmBc,sBAAA,CAAYQ,UAA/B;UACD,CAFD,MAEO,IAAI,IAAAkB,kBAAA,EAAU5C,IAAV,CAAJ,EAAqB;YAC1B,KAAKI,WAAL,GAAmBc,sBAAA,CAAYC,UAA/B;UACD,CAFM,MAEA;YACL,IAAInB,IAAI,YAAY8B,WAApB,EAAiC;cAC/B9B,IAAI,GAAG,IAAIgC,UAAJ,CAAehC,IAAf,CAAP;YACD;;YAED,IAAI,IAAA6C,qBAAA,EAAa7C,IAAb,CAAJ,EAAwB;cACtB,KAAKI,WAAL,GAAmBc,sBAAA,CAAYS,WAA/B;YACD;UACF;;UACD;;QACF,KAAK,QAAL;UACE,IAAI,IAAAkB,qBAAA,EAAa7C,IAAb,CAAJ,EAAwB;YACtB,KAAKI,WAAL,GAAmBc,sBAAA,CAAYmB,WAA/B;UACD;;UACD;;QACF,KAAK,QAAL;UACE,KAAKjC,WAAL,GAAmBc,sBAAA,CAAYoB,MAA/B;UACA;;QAEF;MA7BF;IA+BD"}