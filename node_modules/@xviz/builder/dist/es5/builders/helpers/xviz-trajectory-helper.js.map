{"version":3,"file":"xviz-trajectory-helper.js","names":["getRelativeCoordinates","vertices","basePose","Pose","transformMatrix","getTransformationMatrix","map","p","transform","getPoseTrajectory","poses","startFrame","endFrame","positions","iterationLimit","Math","min","length","i","push","pose","startPose","worldToStartPoseTransformMatrix","invert","currPose","offset","getGeospatialVector","relativeOffset","getGeospatialToPoseTransform","from","to","fromPose","x","y","z","pitch","roll","yaw","worldToFromPoseTransformMatrix","toPose","getTransformationMatrixFromPose","getObjectTrajectory","targetObject","objectFrames","poseFrames","startVehiclePose","limit","lastFrame","motions","getObjectMotions","step","currVehiclePose","longitude","latitude","altitude","fromPoint","turf","destination","sqrt","PI","units","toPoint","distInMeters","distance","bearing","bearingInRadians","degreesToRadians","diffZ","sin","cos","getFrameObjects","frames","frameNumber","Map","get","Array","max","firstFrame","objects","object","find","obj","id"],"sources":["../../../../src/builders/helpers/xviz-trajectory-helper.js"],"sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport {_Pose as Pose} from 'math.gl';\nimport * as turf from '@turf/turf';\n\n/**\n * Given vertices and a base pose, transform the vertices to `basePose` relative coordinates\n * @param vertices {Array} list of [x, y, z] or [x, y]\n * @param basePose {Object} {x, y, z, longitude, latitude, altitude, roll, pitch, yaw}\n * @returns {Array} list of vertices in relative coordinates\n */\nexport function getRelativeCoordinates(vertices, basePose) {\n  if (!(basePose instanceof Pose)) {\n    basePose = new Pose(basePose);\n  }\n\n  const transformMatrix = basePose.getTransformationMatrix();\n  return vertices.map(p => transformMatrix.transform(p));\n}\n\n/**\n * Generate trajectory for list of poses with given start frame and end frame\n * @param poses {Array}, frames of pose data,\n *   each frame contains a `pose` entry with {x, y, z, longitude, latitude, altitude, roll, pitch, yaw}\n * @param startFrame {Number}, start frame of trajectory\n * @param endFrame {Number}, end frame of trajectory\n * @returns {Array} trajectory, list of vertices\n */\nexport function getPoseTrajectory({poses, startFrame, endFrame}) {\n  const positions = [];\n  const iterationLimit = Math.min(endFrame, poses.length);\n\n  for (let i = startFrame; i < iterationLimit; i++) {\n    positions.push(poses[i].pose);\n  }\n\n  const startPose = poses[startFrame].pose;\n  const worldToStartPoseTransformMatrix = new Pose(startPose).getTransformationMatrix().invert();\n\n  return positions.map(currPose => {\n    // offset vector in world coordinate system\n    const offset = getGeospatialVector(startPose, currPose);\n\n    // transform offset to startPose coordinate system\n    const relativeOffset = worldToStartPoseTransformMatrix.transform(offset);\n\n    return relativeOffset;\n  });\n}\n\n/**\n * Return transform matrix that can be used to transform\n * data in `from` pose coordinate system into the `to` pose coordinate system\n *\n * @param from {Object} {longitude, latitude, pitch, roll, yaw}\n * @param to {Object} {longitude, latitude, pitch, roll, yaw}\n * @returns {Object} transformation matrix that converts 'from' relative coordinates into 'to' relative coordinates\n */\nexport function getGeospatialToPoseTransform(from, to) {\n  // Since 'to' is the target, get the vector from 'to -> from'\n  // and use that to set the position of 'from Pose'\n\n  // offset in world coordinate system\n  let offset = getGeospatialVector(from, to);\n\n  const fromPose = new Pose({\n    x: 0,\n    y: 0,\n    z: 0,\n    pitch: from.pitch,\n    roll: from.roll,\n    yaw: from.yaw\n  });\n\n  // transform offset to `fromPose` coordinate\n  // TODO figure out why this step is needed\n  const worldToFromPoseTransformMatrix = fromPose.getTransformationMatrix().invert();\n  offset = worldToFromPoseTransformMatrix.transform(offset);\n\n  const toPose = new Pose({\n    x: offset[0],\n    y: offset[1],\n    z: offset[2],\n    pitch: to.pitch,\n    roll: to.roll,\n    yaw: to.yaw\n  });\n\n  // there is a bug in math.gl https://github.com/uber-web/math.gl/issues/33\n  // pose.getTransformationMatrixFromPose and pose.getTransformationMatrixFromPose are flipped\n  return fromPose.getTransformationMatrixFromPose(toPose);\n}\n\n/**\n * Get object trajectory in pose relative coordinates\n * @param targetObject {Object} {id, x, y, z, ...}\n * @param objectFrames {Array}, all the frames of objects, (object: {id, x, y, z})\n * @param poseFrames {Array}, all the frames of base poses (pose: {longitude, latitude, altitude})\n * @param startFrame {Number}, start frame of trajectory\n * @param endFrame {Number}, end frame of trajectory\n * @returns {Array} trajectory, list of vertices\n */\nexport function getObjectTrajectory({\n  targetObject,\n  objectFrames,\n  poseFrames,\n  startFrame,\n  endFrame\n}) {\n  const vertices = [];\n  const startVehiclePose = poseFrames[startFrame].pose;\n  const limit = Math.min(endFrame, targetObject.lastFrame);\n  const motions = getObjectMotions(targetObject, objectFrames, startFrame, limit);\n\n  for (let i = 0; i < motions.length; i++) {\n    const step = motions[i];\n\n    const currVehiclePose = poseFrames[startFrame + i].pose;\n\n    // matrix to convert data from currVehiclePose relative to startVehiclePose relative.\n    const transformMatrix = getGeospatialToPoseTransform(currVehiclePose, startVehiclePose);\n\n    // objects in curr frame are meters offset based on currVehiclePose\n    // need to convert to the coordinate system of the startVehiclePose\n    const p = transformMatrix.transform([step.x, step.y, step.z]);\n    vertices.push(p);\n  }\n\n  return vertices;\n}\n\n/* eslint-disable complexity */\n/**\n * Get the meter vector from Geospatial coordinates in world coordinate system\n *\n * @param from {Object} {longitude, latitude, altitude, x, y, z}\n * @param to {Object} {longitude, latitude, altitude, x, y, z}\n * @returns {Array} Vector [x, y, z] in meters\n */\nexport function getGeospatialVector(from, to) {\n  from = {\n    longitude: from.longitude || 0,\n    latitude: from.latitude || 0,\n    altitude: from.altitude || 0,\n    x: from.x || 0,\n    y: from.y || 0,\n    z: from.z || 0,\n    yaw: from.yaw || 0\n  };\n\n  to = {\n    longitude: to.longitude || 0,\n    latitude: to.latitude || 0,\n    altitude: to.altitude || 0,\n    x: to.x || 0,\n    y: to.y || 0,\n    z: to.z || 0,\n    yaw: to.yaw || 0\n  };\n\n  const fromPoint = turf.destination(\n    [from.longitude, from.latitude, from.altitude],\n    Math.sqrt(from.x * from.x + from.y * from.y),\n    Math.PI / 2 - from.yaw,\n    {units: 'meters'}\n  );\n\n  const toPoint = turf.destination(\n    [to.longitude, to.latitude, to.altitude],\n    Math.sqrt(to.x * to.x + to.y * to.y),\n    Math.PI / 2 - to.yaw,\n    {units: 'meters'}\n  );\n\n  const distInMeters = turf.distance(fromPoint, toPoint, {units: 'meters'});\n\n  // Bearing is degrees from north, positive is clockwise\n  const bearing = turf.bearing(fromPoint, toPoint);\n  const bearingInRadians = turf.degreesToRadians(bearing);\n\n  const diffZ = to.altitude + to.z - from.altitude - from.z;\n\n  return [\n    distInMeters * Math.sin(bearingInRadians),\n    distInMeters * Math.cos(bearingInRadians),\n    diffZ\n  ];\n}\n/* eslint-enable complexity */\n\nfunction getFrameObjects(frames, frameNumber) {\n  if (frames instanceof Map) {\n    return frames.get(frameNumber);\n  }\n  if (frames instanceof Array) {\n    return frames[frameNumber];\n  }\n  return null;\n}\n\n/**\n * Generate motions for target object\n * @param targetObject {Object} {startFrame, endFrame, id, x, y, z,...}\n * @param objectFrames {Map | Array}, either a Map (key is frameNumber, value is list of objects) or an array of frames\n * @param startFrame {Number}\n * @param endFrame {Number}\n * @returns {Array} list of motions from given startFrame to endFrame\n */\nfunction getObjectMotions(targetObject, objectFrames, startFrame, endFrame) {\n  startFrame = Math.max(targetObject.firstFrame, startFrame);\n  endFrame = Math.min(targetObject.lastFrame, endFrame);\n\n  const motions = [];\n  for (let i = startFrame; i < endFrame; i++) {\n    const objects = getFrameObjects(objectFrames, i);\n    const object = objects.find(obj => obj.id === targetObject.id);\n    motions.push(object);\n  }\n\n  return motions;\n}\n"],"mappings":"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"}