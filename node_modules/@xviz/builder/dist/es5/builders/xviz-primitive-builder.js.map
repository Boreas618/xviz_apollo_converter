{"version":3,"file":"xviz-primitive-builder.js","names":["XVIZPrimitiveBuilder","props","category","CATEGORY","PRIMITIVE","reset","_primitives","data","_type","_flush","Uint8Array","validateError","validatePropSetOnce","PRIMITIVE_TYPES","image","_image","widthPixel","heightPixel","width_px","height_px","vertices","_vertices","polygon","polyline","point","position","radius","_radius","circle","start","end","length","stadium","message","_text","colorArray","_colors","style","_validatePrerequisite","_style","_validateStyle","identifier","_id","classList","_classes","isImage","validateWarn","_streamId","_validate","_flushPrimitives","Object","keys","stream","primitive","_formatPrimitive","arrayFieldName","array","undefined","push","obj","colors","points","text","center","assign","haveBase","base","object_id","classes","_validator","validateStyle","XVIZBaseBuilder"],"sources":["../../../src/builders/xviz-primitive-builder.js"],"sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/* eslint-disable camelcase */\nimport XVIZBaseBuilder from './xviz-base-builder';\nimport {CATEGORY, PRIMITIVE_TYPES} from './constant';\n\nexport default class XVIZPrimitiveBuilder extends XVIZBaseBuilder {\n  constructor(props) {\n    super({\n      category: CATEGORY.PRIMITIVE,\n      ...props\n    });\n\n    this.reset();\n    // primitives: {[streamId]: []}\n    this._primitives = {};\n  }\n\n  image(data) {\n    if (this._type) {\n      this._flush();\n    }\n\n    if (!(data instanceof Uint8Array || typeof data === 'string')) {\n      this.validateError('An image data must be a string or Uint8Array.');\n    }\n\n    this.validatePropSetOnce('_image');\n    this._type = PRIMITIVE_TYPES.image;\n\n    this._image = {\n      data\n    };\n\n    return this;\n  }\n\n  dimensions(widthPixel = null, heightPixel = null) {\n    if (!this._image) {\n      this.validateError('An image needs to be set first.');\n    }\n\n    this._image.width_px = widthPixel;\n    this._image.height_px = heightPixel;\n\n    return this;\n  }\n\n  polygon(vertices) {\n    if (this._type) {\n      this._flush();\n    }\n\n    this.validatePropSetOnce('_vertices');\n\n    this._vertices = vertices;\n    this._type = PRIMITIVE_TYPES.polygon;\n\n    return this;\n  }\n\n  polyline(vertices) {\n    if (this._type) {\n      this._flush();\n    }\n\n    this.validatePropSetOnce('_vertices');\n\n    this._vertices = vertices;\n    this._type = PRIMITIVE_TYPES.polyline;\n\n    return this;\n  }\n\n  points(vertices) {\n    if (this._type) {\n      this._flush();\n    }\n\n    this.validatePropSetOnce('_vertices');\n\n    this._vertices = vertices;\n    this._type = PRIMITIVE_TYPES.point;\n\n    return this;\n  }\n\n  circle(position, radius) {\n    if (this._type) {\n      this._flush();\n    }\n\n    this.validatePropSetOnce('_radius');\n\n    this.position(position);\n\n    this._radius = radius;\n    this._type = PRIMITIVE_TYPES.circle;\n\n    return this;\n  }\n\n  stadium(start, end, radius) {\n    if (this._type) {\n      this._flush();\n    }\n\n    this.validatePropSetOnce('_radius');\n\n    if (start.length !== 3) {\n      this.validateError(\n        `The start position must be of the form [x, y, z] where ${start} was provided`\n      );\n    }\n\n    if (end.length !== 3) {\n      this.validateError(\n        `The end position must be of the form [x, y, z] where ${end} was provided`\n      );\n    }\n\n    this._vertices = [start, end];\n    this._radius = radius;\n    this._type = PRIMITIVE_TYPES.stadium;\n\n    return this;\n  }\n\n  // TODO/Xintong validate `text` primitive\n  text(message) {\n    if (this._type) {\n      this._flush();\n    }\n\n    this._text = message;\n    this._type = 'text';\n    return this;\n  }\n\n  position(point) {\n    this.validatePropSetOnce('_vertices');\n\n    if (point.length !== 3) {\n      this.validateError(`A position must be of the form [x, y, z] where ${point} was provided`);\n    }\n\n    this._vertices = [point];\n    return this;\n  }\n\n  colors(colorArray) {\n    this.validatePropSetOnce('_colors');\n\n    this._colors = colorArray;\n    return this;\n  }\n\n  style(style) {\n    this._validatePrerequisite();\n    this.validatePropSetOnce('_style');\n\n    this._style = style;\n\n    this._validateStyle();\n\n    return this;\n  }\n\n  id(identifier) {\n    this._validatePrerequisite();\n    this.validatePropSetOnce('_id');\n\n    this._id = identifier;\n    return this;\n  }\n\n  classes(classList) {\n    this._validatePrerequisite();\n    this.validatePropSetOnce('_classes');\n\n    this._classes = classList;\n    return this;\n  }\n\n  _validate() {\n    super._validate();\n\n    const isImage = this._type === PRIMITIVE_TYPES.image;\n    if (isImage && (!this._image || !this._image.data)) {\n      this.validateWarn(`Stream ${this._streamId} image data are not provided.`);\n    }\n    if (!isImage && !this._vertices) {\n      this.validateWarn(`Stream ${this._streamId} primitives vertices are not provided.`);\n    }\n  }\n\n  _flush() {\n    this._validate();\n    this._flushPrimitives();\n  }\n\n  getData() {\n    if (this._type) {\n      this._flush();\n    }\n\n    if (Object.keys(this._primitives).length === 0) {\n      return null;\n    }\n\n    return this._primitives;\n  }\n\n  _validatePrerequisite() {\n    if (!this._type) {\n      this.validateError('Start from a primitive first, e.g polygon(), image(), etc.');\n    }\n  }\n\n  _flushPrimitives() {\n    let stream = this._primitives[this._streamId];\n    if (!stream) {\n      stream = {};\n      this._primitives[this._streamId] = stream;\n    }\n\n    const primitive = this._formatPrimitive();\n\n    // Each type like \"image\" has an \"images\" array, this hack saves a\n    // big switch statement.\n    const arrayFieldName = `${this._type}s`;\n    let array = stream[arrayFieldName];\n\n    // Make sure array exists\n    if (array === undefined) {\n      array = [];\n      stream[arrayFieldName] = array;\n    }\n\n    // Now add the primitive to it\n    array.push(primitive);\n\n    this.reset();\n  }\n\n  /* eslint-disable complexity */\n  _formatPrimitive() {\n    const obj = {};\n\n    switch (this._type) {\n      case 'polygon':\n      case 'polyline':\n        obj.vertices = this._vertices;\n        break;\n      case 'point':\n        if (this._colors) {\n          obj.colors = this._colors;\n        }\n        obj.points = this._vertices;\n        break;\n      case 'text':\n        obj.position = this._vertices[0];\n        obj.text = this._text;\n        break;\n      case 'circle':\n        obj.center = this._vertices[0];\n        obj.radius = this._radius;\n        break;\n      case 'stadium':\n        obj.start = this._vertices[0];\n        obj.end = this._vertices[1];\n        obj.radius = this._radius;\n        break;\n      case 'image':\n        if (this._vertices) {\n          this._image.position = this._vertices[0];\n        }\n        Object.assign(obj, this._image);\n        break;\n      default:\n    }\n\n    let haveBase = false;\n    const base = {};\n\n    if (this._id) {\n      haveBase = true;\n      base.object_id = this._id;\n    }\n\n    if (this._style) {\n      haveBase = true;\n      base.style = this._style;\n    }\n\n    if (this._classes) {\n      haveBase = true;\n      base.classes = this._classes;\n    }\n\n    if (haveBase) {\n      obj.base = base;\n    }\n\n    return obj;\n  }\n  /* eslint-enable complexity */\n\n  _validateStyle() {\n    this._validator.validateStyle(this);\n  }\n\n  reset() {\n    this._type = null;\n\n    this._image = null;\n    this._vertices = null;\n    this._radius = null;\n    this._text = null;\n    this._colors = null;\n\n    this._id = null;\n    this._style = null;\n    this._classes = null;\n  }\n}\n"],"mappings":"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"}