{"version":3,"file":"xviz-metadata-builder.js","names":["_Pose","Pose","Matrix4","CATEGORY","defaultValidateWarn","console","warn","defaultValidateError","error","XVIZMetadataBuilder","validateWarn","validateError","_validateWarn","_validateError","data","streams","streamId","tmp_ui_builder","tmp_stream","tmp_matrix_transform","tmp_pose_transform","tmp_log_info","tmp_type","_flush","metadata","version","Object","keys","length","log_info","panels","getUI","ui_config","panelKey","name","config","time","start_time","end_time","xvizUIBuilder","category","toUpperCase","t","source","u","units","coordinate","matrix","Array","position","orientation","x","y","z","roll","pitch","yaw","pose","getTransformationMatrix","style","stream_style","streamRule","style_classes","push","streamData","transform","PRIMITIVE","FUTURE_INSTANCE","primitive_type","VARIABLE","TIME_SERIES","scalar_type","_reset"],"sources":["../../../src/builders/xviz-metadata-builder.js"],"sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n// Note: XVIZ data structures use snake_case\n/* eslint-disable camelcase */\nimport {_Pose as Pose, Matrix4} from 'math.gl';\nimport {CATEGORY} from './constant';\n\n/* global console */\n/* eslint-disable no-console */\nconst defaultValidateWarn = console.warn;\nconst defaultValidateError = console.error;\n/* eslint-enable no-console */\n\nexport default class XVIZMetadataBuilder {\n  constructor({validateWarn = defaultValidateWarn, validateError = defaultValidateError} = {}) {\n    this._validateWarn = validateWarn;\n    this._validateError = validateError;\n\n    this.data = {\n      streams: {}\n    };\n\n    this.streamId = null;\n    this.tmp_ui_builder = null;\n    this.tmp_stream = {};\n    this.tmp_matrix_transform = null;\n    this.tmp_pose_transform = null;\n    this.tmp_log_info = {};\n    this.tmp_type = null;\n    // TODO:\n    // cameras\n    // stream_aliases\n    // ui_config\n    // map_info\n    // vehicle_info\n  }\n\n  getMetadata() {\n    this._flush();\n\n    const metadata = {\n      version: '2.0.0',\n      ...this.data\n    };\n\n    if (Object.keys(this.tmp_log_info).length > 0) {\n      metadata.log_info = this.tmp_log_info;\n    }\n    if (this.tmp_ui_builder) {\n      const panels = this.tmp_ui_builder.getUI();\n      metadata.ui_config = {};\n\n      // Wrap the individual panels in the ui_panel_info structure\n      for (const panelKey of Object.keys(panels)) {\n        metadata.ui_config[panelKey] = {\n          name: panels[panelKey].name,\n          config: panels[panelKey]\n        };\n      }\n    }\n\n    return metadata;\n  }\n\n  startTime(time) {\n    this.tmp_log_info.start_time = time;\n    return this;\n  }\n\n  endTime(time) {\n    this.tmp_log_info.end_time = time;\n    return this;\n  }\n\n  ui(xvizUIBuilder) {\n    this.tmp_ui_builder = xvizUIBuilder;\n    return this;\n  }\n\n  stream(streamId) {\n    if (this.streamId) {\n      this._flush();\n    }\n\n    this.streamId = streamId;\n    return this;\n  }\n\n  // Used for validation in XVIZBuilder\n  category(category) {\n    this.tmp_stream.category = category.toUpperCase();\n    return this;\n  }\n\n  // Used for validation in XVIZBuilder\n  type(t) {\n    this.tmp_type = t.toUpperCase();\n    return this;\n  }\n\n  source(source) {\n    this.tmp_stream.source = source;\n    return this;\n  }\n\n  unit(u) {\n    this.tmp_stream.units = u;\n    return this;\n  }\n\n  coordinate(coordinate) {\n    this.tmp_stream.coordinate = coordinate;\n    return this;\n  }\n\n  transformMatrix(matrix) {\n    if (matrix instanceof Array) {\n      matrix = new Matrix4(matrix);\n    }\n\n    this.tmp_matrix_transform = matrix;\n    return this;\n  }\n\n  pose(position = {}, orientation = {}) {\n    const {x = 0, y = 0, z = 0} = position;\n    const {roll = 0, pitch = 0, yaw = 0} = orientation;\n    const pose = new Pose({x, y, z, roll, pitch, yaw});\n    this.tmp_pose_transform = pose.getTransformationMatrix();\n    return this;\n  }\n\n  streamStyle(style) {\n    this.tmp_stream.stream_style = style;\n    return this;\n  }\n\n  styleClass(name, style) {\n    if (!this.streamId) {\n      this._validateError('A stream must set before adding a style rule.');\n      return this;\n    }\n\n    const streamRule = {\n      name,\n      style\n    };\n\n    if (!this.tmp_stream.style_classes) {\n      this.tmp_stream.style_classes = [streamRule];\n    } else {\n      this.tmp_stream.style_classes.push(streamRule);\n    }\n    return this;\n  }\n\n  logInfo(data) {\n    this.tmp_log_info = {...data, ...this.tmp_log_info};\n    return this;\n  }\n\n  _flush() {\n    if (this.streamId) {\n      const streamData = this.tmp_stream;\n\n      let transform = null;\n      if (this.tmp_pose_transform && this.tmp_matrix_transform) {\n        this._validateError('`pose` and `transformMatrix` cannot be applied at the same time.');\n      } else {\n        transform = this.tmp_matrix_transform || this.tmp_pose_transform;\n      }\n\n      if (transform) {\n        streamData.transform = transform;\n      }\n\n      if (\n        streamData.category === CATEGORY.PRIMITIVE ||\n        streamData.category === CATEGORY.FUTURE_INSTANCE\n      ) {\n        streamData.primitive_type = this.tmp_type;\n      } else if (\n        streamData.category === CATEGORY.VARIABLE ||\n        streamData.category === CATEGORY.TIME_SERIES\n      ) {\n        streamData.scalar_type = this.tmp_type;\n      }\n\n      this.data.streams[this.streamId] = streamData;\n    }\n\n    this._reset();\n  }\n\n  _reset() {\n    this.streamId = null;\n    this.tmp_stream = {};\n    this.tmp_matrix_transform = null;\n    this.tmp_pose_transform = null;\n    this.tmp_type = null;\n  }\n}\n"],"mappings":";;;;;;;;AAgBA,SAAQA,KAAK,IAAIC,IAAjB,EAAuBC,OAAvB,QAAqC,SAArC;AACA,SAAQC,QAAR,QAAuB,YAAvB;AAIA,IAAMC,mBAAmB,GAAGC,OAAO,CAACC,IAApC;AACA,IAAMC,oBAAoB,GAAGF,OAAO,CAACG,KAArC;;IAGqBC,mB;EACnB,+BAA6F;IAAA,+EAAJ,EAAI;IAAA,6BAAhFC,YAAgF;IAAA,IAAhFA,YAAgF,kCAAjEN,mBAAiE;IAAA,8BAA5CO,aAA4C;IAAA,IAA5CA,aAA4C,mCAA5BJ,oBAA4B;;IAAA;;IAC3F,KAAKK,aAAL,GAAqBF,YAArB;IACA,KAAKG,cAAL,GAAsBF,aAAtB;IAEA,KAAKG,IAAL,GAAY;MACVC,OAAO,EAAE;IADC,CAAZ;IAIA,KAAKC,QAAL,GAAgB,IAAhB;IACA,KAAKC,cAAL,GAAsB,IAAtB;IACA,KAAKC,UAAL,GAAkB,EAAlB;IACA,KAAKC,oBAAL,GAA4B,IAA5B;IACA,KAAKC,kBAAL,GAA0B,IAA1B;IACA,KAAKC,YAAL,GAAoB,EAApB;IACA,KAAKC,QAAL,GAAgB,IAAhB;EAOD;;;;WAED,uBAAc;MACZ,KAAKC,MAAL;;MAEA,IAAMC,QAAQ;QACZC,OAAO,EAAE;MADG,GAET,KAAKX,IAFI,CAAd;;MAKA,IAAIY,MAAM,CAACC,IAAP,CAAY,KAAKN,YAAjB,EAA+BO,MAA/B,GAAwC,CAA5C,EAA+C;QAC7CJ,QAAQ,CAACK,QAAT,GAAoB,KAAKR,YAAzB;MACD;;MACD,IAAI,KAAKJ,cAAT,EAAyB;QACvB,IAAMa,MAAM,GAAG,KAAKb,cAAL,CAAoBc,KAApB,EAAf;QACAP,QAAQ,CAACQ,SAAT,GAAqB,EAArB;;QAGA,gCAAuBN,MAAM,CAACC,IAAP,CAAYG,MAAZ,CAAvB,kCAA4C;UAAvC,IAAMG,QAAQ,mBAAd;UACHT,QAAQ,CAACQ,SAAT,CAAmBC,QAAnB,IAA+B;YAC7BC,IAAI,EAAEJ,MAAM,CAACG,QAAD,CAAN,CAAiBC,IADM;YAE7BC,MAAM,EAAEL,MAAM,CAACG,QAAD;UAFe,CAA/B;QAID;MACF;;MAED,OAAOT,QAAP;IACD;;;WAED,mBAAUY,IAAV,EAAgB;MACd,KAAKf,YAAL,CAAkBgB,UAAlB,GAA+BD,IAA/B;MACA,OAAO,IAAP;IACD;;;WAED,iBAAQA,IAAR,EAAc;MACZ,KAAKf,YAAL,CAAkBiB,QAAlB,GAA6BF,IAA7B;MACA,OAAO,IAAP;IACD;;;WAED,YAAGG,aAAH,EAAkB;MAChB,KAAKtB,cAAL,GAAsBsB,aAAtB;MACA,OAAO,IAAP;IACD;;;WAED,gBAAOvB,QAAP,EAAiB;MACf,IAAI,KAAKA,QAAT,EAAmB;QACjB,KAAKO,MAAL;MACD;;MAED,KAAKP,QAAL,GAAgBA,QAAhB;MACA,OAAO,IAAP;IACD;;;WAGD,kBAASwB,SAAT,EAAmB;MACjB,KAAKtB,UAAL,CAAgBsB,QAAhB,GAA2BA,SAAQ,CAACC,WAAT,EAA3B;MACA,OAAO,IAAP;IACD;;;WAGD,cAAKC,CAAL,EAAQ;MACN,KAAKpB,QAAL,GAAgBoB,CAAC,CAACD,WAAF,EAAhB;MACA,OAAO,IAAP;IACD;;;WAED,gBAAOE,OAAP,EAAe;MACb,KAAKzB,UAAL,CAAgByB,MAAhB,GAAyBA,OAAzB;MACA,OAAO,IAAP;IACD;;;WAED,cAAKC,CAAL,EAAQ;MACN,KAAK1B,UAAL,CAAgB2B,KAAhB,GAAwBD,CAAxB;MACA,OAAO,IAAP;IACD;;;WAED,oBAAWE,WAAX,EAAuB;MACrB,KAAK5B,UAAL,CAAgB4B,UAAhB,GAA6BA,WAA7B;MACA,OAAO,IAAP;IACD;;;WAED,yBAAgBC,MAAhB,EAAwB;MACtB,IAAIA,MAAM,YAAYC,KAAtB,EAA6B;QAC3BD,MAAM,GAAG,IAAI7C,OAAJ,CAAY6C,MAAZ,CAAT;MACD;;MAED,KAAK5B,oBAAL,GAA4B4B,MAA5B;MACA,OAAO,IAAP;IACD;;;WAED,gBAAsC;MAAA,IAAjCE,QAAiC,uEAAtB,EAAsB;MAAA,IAAlBC,WAAkB,uEAAJ,EAAI;MACpC,kBAA8BD,QAA9B,CAAOE,CAAP;MAAA,IAAOA,CAAP,4BAAW,CAAX;MAAA,kBAA8BF,QAA9B,CAAcG,CAAd;MAAA,IAAcA,CAAd,4BAAkB,CAAlB;MAAA,kBAA8BH,QAA9B,CAAqBI,CAArB;MAAA,IAAqBA,CAArB,4BAAyB,CAAzB;MACA,wBAAuCH,WAAvC,CAAOI,IAAP;MAAA,IAAOA,IAAP,kCAAc,CAAd;MAAA,yBAAuCJ,WAAvC,CAAiBK,KAAjB;MAAA,IAAiBA,KAAjB,mCAAyB,CAAzB;MAAA,uBAAuCL,WAAvC,CAA4BM,GAA5B;MAAA,IAA4BA,GAA5B,iCAAkC,CAAlC;MACA,IAAMC,IAAI,GAAG,IAAIxD,IAAJ,CAAS;QAACkD,CAAC,EAADA,CAAD;QAAIC,CAAC,EAADA,CAAJ;QAAOC,CAAC,EAADA,CAAP;QAAUC,IAAI,EAAJA,IAAV;QAAgBC,KAAK,EAALA,KAAhB;QAAuBC,GAAG,EAAHA;MAAvB,CAAT,CAAb;MACA,KAAKpC,kBAAL,GAA0BqC,IAAI,CAACC,uBAAL,EAA1B;MACA,OAAO,IAAP;IACD;;;WAED,qBAAYC,KAAZ,EAAmB;MACjB,KAAKzC,UAAL,CAAgB0C,YAAhB,GAA+BD,KAA/B;MACA,OAAO,IAAP;IACD;;;WAED,oBAAWzB,IAAX,EAAiByB,KAAjB,EAAwB;MACtB,IAAI,CAAC,KAAK3C,QAAV,EAAoB;QAClB,KAAKH,cAAL,CAAoB,+CAApB;;QACA,OAAO,IAAP;MACD;;MAED,IAAMgD,UAAU,GAAG;QACjB3B,IAAI,EAAJA,IADiB;QAEjByB,KAAK,EAALA;MAFiB,CAAnB;;MAKA,IAAI,CAAC,KAAKzC,UAAL,CAAgB4C,aAArB,EAAoC;QAClC,KAAK5C,UAAL,CAAgB4C,aAAhB,GAAgC,CAACD,UAAD,CAAhC;MACD,CAFD,MAEO;QACL,KAAK3C,UAAL,CAAgB4C,aAAhB,CAA8BC,IAA9B,CAAmCF,UAAnC;MACD;;MACD,OAAO,IAAP;IACD;;;WAED,iBAAQ/C,IAAR,EAAc;MACZ,KAAKO,YAAL,mCAAwBP,IAAxB,GAAiC,KAAKO,YAAtC;MACA,OAAO,IAAP;IACD;;;WAED,kBAAS;MACP,IAAI,KAAKL,QAAT,EAAmB;QACjB,IAAMgD,UAAU,GAAG,KAAK9C,UAAxB;QAEA,IAAI+C,SAAS,GAAG,IAAhB;;QACA,IAAI,KAAK7C,kBAAL,IAA2B,KAAKD,oBAApC,EAA0D;UACxD,KAAKN,cAAL,CAAoB,kEAApB;QACD,CAFD,MAEO;UACLoD,SAAS,GAAG,KAAK9C,oBAAL,IAA6B,KAAKC,kBAA9C;QACD;;QAED,IAAI6C,SAAJ,EAAe;UACbD,UAAU,CAACC,SAAX,GAAuBA,SAAvB;QACD;;QAED,IACED,UAAU,CAACxB,QAAX,KAAwBrC,QAAQ,CAAC+D,SAAjC,IACAF,UAAU,CAACxB,QAAX,KAAwBrC,QAAQ,CAACgE,eAFnC,EAGE;UACAH,UAAU,CAACI,cAAX,GAA4B,KAAK9C,QAAjC;QACD,CALD,MAKO,IACL0C,UAAU,CAACxB,QAAX,KAAwBrC,QAAQ,CAACkE,QAAjC,IACAL,UAAU,CAACxB,QAAX,KAAwBrC,QAAQ,CAACmE,WAF5B,EAGL;UACAN,UAAU,CAACO,WAAX,GAAyB,KAAKjD,QAA9B;QACD;;QAED,KAAKR,IAAL,CAAUC,OAAV,CAAkB,KAAKC,QAAvB,IAAmCgD,UAAnC;MACD;;MAED,KAAKQ,MAAL;IACD;;;WAED,kBAAS;MACP,KAAKxD,QAAL,GAAgB,IAAhB;MACA,KAAKE,UAAL,GAAkB,EAAlB;MACA,KAAKC,oBAAL,GAA4B,IAA5B;MACA,KAAKC,kBAAL,GAA0B,IAA1B;MACA,KAAKE,QAAL,GAAgB,IAAhB;IACD;;;;;;SA3LkBb,mB"}