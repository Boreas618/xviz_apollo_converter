{"version":3,"file":"load-uri.js","names":["loadUri","uri","rootFolder","path","module","require","fs","startsWith","Promise","reject","Error","resolve","parseDataUri","filePath","join","readFileAsync","then","buffer","dataIndex","indexOf","mimeType","slice","Buffer","trim","decodeURIComponent"],"sources":["../../../src/utils/load-uri.js"],"sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n// Based on binary-gltf-utils under MIT license: Copyright (c) 2016-17 Karl Cheng\n\n/* global Buffer */\n\nexport function loadUri(uri, rootFolder = '.') {\n  const path = module.require('path');\n  const fs = module.require('fs');\n\n  if (uri.startsWith('http:') || uri.startsWith('https:')) {\n    return Promise.reject(new Error('request based loading of URIs not implemented'));\n  }\n\n  if (uri.startsWith('data:')) {\n    return Promise.resolve(parseDataUri(uri));\n  }\n\n  const filePath = path.join((rootFolder = '.'), uri);\n  return fs.readFileAsync(filePath).then(buffer => ({buffer}));\n}\n\n/**\n * Parses a data URI into a buffer, as well as retrieving its declared MIME type.\n *\n * @param {string} uri - a data URI (assumed to be valid)\n * @returns {Object} { buffer, mimeType }\n */\nexport function parseDataUri(uri) {\n  const dataIndex = uri.indexOf(',');\n\n  let buffer;\n  let mimeType;\n  if (uri.slice(dataIndex - 7, dataIndex) === ';base64') {\n    buffer = new Buffer(uri.slice(dataIndex + 1), 'base64');\n    mimeType = uri.slice(5, dataIndex - 7).trim();\n  } else {\n    buffer = new Buffer(decodeURIComponent(uri.slice(dataIndex + 1)));\n    mimeType = uri.slice(5, dataIndex).trim();\n  }\n\n  if (!mimeType) {\n    mimeType = 'text/plain;charset=US-ASCII';\n  } else if (mimeType[0] === ';') {\n    mimeType = `text/plain${mimeType}`;\n  }\n\n  return {buffer, mimeType};\n}\n"],"mappings":"AAkBA,OAAO,SAASA,OAAT,CAAiBC,GAAjB,EAAwC;EAAA,IAAlBC,UAAkB,uEAAL,GAAK;;EAC7C,MAAMC,IAAI,GAAGC,MAAM,CAACC,OAAP,CAAe,MAAf,CAAb;;EACA,MAAMC,EAAE,GAAGF,MAAM,CAACC,OAAP,CAAe,IAAf,CAAX;;EAEA,IAAIJ,GAAG,CAACM,UAAJ,CAAe,OAAf,KAA2BN,GAAG,CAACM,UAAJ,CAAe,QAAf,CAA/B,EAAyD;IACvD,OAAOC,OAAO,CAACC,MAAR,CAAe,IAAIC,KAAJ,CAAU,+CAAV,CAAf,CAAP;EACD;;EAED,IAAIT,GAAG,CAACM,UAAJ,CAAe,OAAf,CAAJ,EAA6B;IAC3B,OAAOC,OAAO,CAACG,OAAR,CAAgBC,YAAY,CAACX,GAAD,CAA5B,CAAP;EACD;;EAED,MAAMY,QAAQ,GAAGV,IAAI,CAACW,IAAL,CAAWZ,UAAU,GAAG,GAAxB,EAA8BD,GAA9B,CAAjB;EACA,OAAOK,EAAE,CAACS,aAAH,CAAiBF,QAAjB,EAA2BG,IAA3B,CAAgCC,MAAM,KAAK;IAACA;EAAD,CAAL,CAAtC,CAAP;AACD;AAQD,OAAO,SAASL,YAAT,CAAsBX,GAAtB,EAA2B;EAChC,MAAMiB,SAAS,GAAGjB,GAAG,CAACkB,OAAJ,CAAY,GAAZ,CAAlB;EAEA,IAAIF,MAAJ;EACA,IAAIG,QAAJ;;EACA,IAAInB,GAAG,CAACoB,KAAJ,CAAUH,SAAS,GAAG,CAAtB,EAAyBA,SAAzB,MAAwC,SAA5C,EAAuD;IACrDD,MAAM,GAAG,IAAIK,MAAJ,CAAWrB,GAAG,CAACoB,KAAJ,CAAUH,SAAS,GAAG,CAAtB,CAAX,EAAqC,QAArC,CAAT;IACAE,QAAQ,GAAGnB,GAAG,CAACoB,KAAJ,CAAU,CAAV,EAAaH,SAAS,GAAG,CAAzB,EAA4BK,IAA5B,EAAX;EACD,CAHD,MAGO;IACLN,MAAM,GAAG,IAAIK,MAAJ,CAAWE,kBAAkB,CAACvB,GAAG,CAACoB,KAAJ,CAAUH,SAAS,GAAG,CAAtB,CAAD,CAA7B,CAAT;IACAE,QAAQ,GAAGnB,GAAG,CAACoB,KAAJ,CAAU,CAAV,EAAaH,SAAb,EAAwBK,IAAxB,EAAX;EACD;;EAED,IAAI,CAACH,QAAL,EAAe;IACbA,QAAQ,GAAG,6BAAX;EACD,CAFD,MAEO,IAAIA,QAAQ,CAAC,CAAD,CAAR,KAAgB,GAApB,EAAyB;IAC9BA,QAAQ,uBAAgBA,QAAhB,CAAR;EACD;;EAED,OAAO;IAACH,MAAD;IAASG;EAAT,CAAP;AACD"}