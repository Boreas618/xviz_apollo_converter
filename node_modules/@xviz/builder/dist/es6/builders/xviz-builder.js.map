{"version":3,"file":"xviz-builder.js","names":["XVIZPoseBuilder","XVIZLinkBuilder","XVIZPrimitiveBuilder","XVIZFutureInstanceBuilder","XVIZUIPrimitiveBuilder","XVIZTimeSeriesBuilder","XVIZValidator","XVIZVariableBuilder","PRIMARY_POSE_STREAM","defaultValidateWarn","console","warn","defaultValidateError","error","XVIZBuilder","constructor","metadata","disableStreams","validateWarn","validateError","_validator","updateType","_streamBuilder","_timestamp","_poseBuilder","validator","_variablesBuilder","_primitivesBuilder","_futureInstanceBuilder","_uiPrimitivesBuilder","_timeSeriesBuilder","_linkBuilder","persistent","timestamp","ts","pose","streamId","stream","link","parent","child","variable","primitive","futureInstance","uiPrimitive","timeSeries","getMessage","poses","getData","primitives","futures","variables","uiPrimitives","links","data","future_instances","time_series","ui_primitives","message","update_type","updates","getFrame","_reset"],"sources":["../../../src/builders/xviz-builder.js"],"sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n// Note: XVIZ data structures use snake_case\n/* eslint-disable camelcase */\nimport XVIZPoseBuilder from './xviz-pose-builder';\nimport XVIZLinkBuilder from './xviz-link-builder';\nimport XVIZPrimitiveBuilder from './xviz-primitive-builder';\nimport XVIZFutureInstanceBuilder from './xviz-future-instance-builder';\nimport XVIZUIPrimitiveBuilder from './xviz-ui-primitive-builder';\nimport XVIZTimeSeriesBuilder from './xviz-time-series-builder';\nimport XVIZValidator from './xviz-validator';\nimport XVIZVariableBuilder from './xviz-variable-builder';\nimport {PRIMARY_POSE_STREAM} from './constant';\n\n/* global console */\n/* eslint-disable no-console */\nconst defaultValidateWarn = console.warn;\nconst defaultValidateError = console.error;\n/* eslint-enable no-console */\n\n// TODO: Builder could validate against stream metadata!\nexport default class XVIZBuilder {\n  constructor({\n    metadata = {},\n    disableStreams = [],\n    validateWarn = defaultValidateWarn,\n    validateError = defaultValidateError\n  } = {}) {\n    this._validator = new XVIZValidator({\n      validateWarn,\n      validateError\n    });\n\n    this.metadata = metadata;\n    this.disableStreams = disableStreams;\n\n    this.updateType = 'SNAPSHOT';\n\n    // Current streamBuilder\n    this._streamBuilder = null;\n    this._timestamp = null;\n\n    // Construct different builders\n    this._poseBuilder = new XVIZPoseBuilder({\n      metadata: this.metadata,\n      validator: this._validator\n    });\n    this._variablesBuilder = new XVIZVariableBuilder({\n      metadata: this.metadata,\n      validator: this._validator\n    });\n    this._primitivesBuilder = new XVIZPrimitiveBuilder({\n      metadata: this.metadata,\n      validator: this._validator\n    });\n    this._futureInstanceBuilder = new XVIZFutureInstanceBuilder({\n      metadata: this.metadata,\n      validator: this._validator\n    });\n    this._uiPrimitivesBuilder = new XVIZUIPrimitiveBuilder({\n      metadata: this.metadata,\n      validator: this._validator\n    });\n    this._timeSeriesBuilder = new XVIZTimeSeriesBuilder({\n      metadata: this.metadata,\n      validator: this._validator\n    });\n    this._linkBuilder = new XVIZLinkBuilder({\n      metadata: this.metadata,\n      validator: this._validator\n    });\n  }\n\n  persistent() {\n    this.updateType = 'PERSISTENT';\n  }\n\n  timestamp(ts) {\n    this._timestamp = ts;\n  }\n\n  pose(streamId = PRIMARY_POSE_STREAM) {\n    this._streamBuilder = this._poseBuilder.stream(streamId);\n    return this._streamBuilder;\n  }\n\n  link(parent, child) {\n    this._streamBuilder = this._linkBuilder.stream(child).parent(parent);\n    return this._streamBuilder;\n  }\n\n  variable(streamId) {\n    this._streamBuilder = this._variablesBuilder.stream(streamId);\n    return this._streamBuilder;\n  }\n\n  primitive(streamId) {\n    this._streamBuilder = this._primitivesBuilder.stream(streamId);\n    return this._streamBuilder;\n  }\n\n  futureInstance(streamId, timestamp) {\n    this._streamBuilder = this._futureInstanceBuilder.stream(streamId);\n    this._streamBuilder._timestamp(timestamp);\n    return this._streamBuilder;\n  }\n\n  uiPrimitive(streamId) {\n    this._streamBuilder = this._uiPrimitivesBuilder.stream(streamId);\n    return this._streamBuilder;\n  }\n\n  timeSeries(streamId) {\n    this._streamBuilder = this._timeSeriesBuilder.stream(streamId);\n    return this._streamBuilder;\n  }\n\n  /*\n  message data:\n  {\n    update_type: 'SNAPSHOT',\n    updates: [{\n      timestamp,\n      poses: {'/vehicle-pose': {}, ...},\n      primitives: {},\n      variables: {},\n      future_instances: {}\n    }]\n  }\n   */\n  /* eslint-disable max-statements, complexity */\n  getMessage() {\n    const {poses} = this._poseBuilder.getData();\n    let ts = this._timestamp;\n\n    if (!ts && poses && poses[PRIMARY_POSE_STREAM]) {\n      ts = poses[PRIMARY_POSE_STREAM].timestamp;\n    }\n\n    if (!ts) {\n      this._validator.error(\n        `A message requires a timestamp. Ensure builder.timestamp() is called.`\n      );\n    }\n\n    const primitives = this._primitivesBuilder.getData();\n    const futures = this._futureInstanceBuilder.getData();\n    const variables = this._variablesBuilder.getData();\n    const timeSeries = this._timeSeriesBuilder.getData();\n    const uiPrimitives = this._uiPrimitivesBuilder.getData();\n    const links = this._linkBuilder.getData();\n\n    const data = {\n      timestamp: ts\n    };\n\n    if (poses) {\n      data.poses = poses;\n    }\n\n    if (primitives) {\n      data.primitives = primitives;\n    }\n    if (futures) {\n      data.future_instances = futures;\n    }\n    if (variables) {\n      data.variables = variables;\n    }\n    if (timeSeries) {\n      data.time_series = timeSeries;\n    }\n    if (uiPrimitives) {\n      data.ui_primitives = uiPrimitives;\n    }\n    if (links) {\n      data.links = links;\n    }\n\n    const message = {\n      update_type: this.updateType,\n      updates: [data]\n    };\n\n    return message;\n  }\n  /* eslint-enable max-statements, complexity */\n\n  // DEPRECATED: change to using getMessage()\n  getFrame() {\n    return this.getMessage();\n  }\n\n  _reset() {\n    this._streamBuilder = null;\n    this._timestamp = null;\n  }\n}\n"],"mappings":"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"}